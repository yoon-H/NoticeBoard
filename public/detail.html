<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상세 페이지</title>
    <style>
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;

            padding: 0px;

            border-bottom-color: crimson;
            border-bottom-width: 5px;
            border-bottom-style: solid;
        }

        #my-title {
            display: inline-block;
            vertical-align: middle;

            margin: 8px;
            padding: 0;
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        li.icon {
            flex-basis: 25%;
        }

        a {
            display: block;
            text-align: center;

            text-decoration: none;
            color: black;
        }

        a:hover {
            text-decoration: underline;
        }

        header a {
            margin: 4px;
            margin-bottom: 0;
            padding: 8px 16px;
            padding-bottom: 0;
        }

        #post-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }


        #post-header {
            margin: 16px 0;

            border-bottom-color: rgb(255, 81, 81);
            border-bottom-width: 2px;
            border-bottom-style: solid;
        }

        #post-header #title {
            margin: 0;
        }

        #post-info {
            display: flex;
            justify-content: flex-end;
            margin: 0;
            gap: 15px;
        }

        .time {
            color: gray;
        }

        #post-info #author {}

        #post-btns {
            display: flex;
            justify-content: flex-end;
            margin: 5px 0;
            gap: 15px;
        }

        button {
            border: none;
            outline: none;

            cursor: pointer;

            background-color: white;
        }

        #post-content {
            border-bottom-color: rgb(255, 81, 81);
            border-bottom-width: 2px;
            border-bottom-style: solid;
        }

        #comment-container {}

        .comment {
            border-bottom-color: rgb(255, 81, 81);
            border-bottom-width: 1px;
            border-bottom-style: solid;
        }

        .comment .comment-info {
            display: flex;
            gap: 10px;
        }
    </style>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script>
        $(document).ready(function () {
            const root = 'http://localhost:3000/api';

            const params = new URLSearchParams(window.location.search);
            const postId = params.get("id");
            let authorId;

            // 글 element
            const title = document.getElementById("title");
            const postTime = document.getElementById("post-time");
            const author = document.getElementById("author");
            const content = document.getElementById("post-content");

            // 글 조회
            $.ajax({
                url: root + `/posts/${postId}`,
                method: 'get',
                success: function (data) {
                    if (!data) return;

                    title.textContent = data.title;
                    postTime.textContent = data.time;
                    author.textContent = data.author;
                    content.textContent = data.content;

                    authorId = data.userId;
                },
                error: function (req, status, err) {
                    const res = req.responseJSON;

                    if (res && res.message)
                        alert(res.message);

                    return;
                }
            });

            // 코멘트 조회
            const commentContainer = document.getElementById("comment-container");

            $.ajax({
                url: root + `/posts/${postId}/comments`,
                method: 'get',
                success: function (data) {
                    if (!data) return;

                    for (const comment of data) {
                        commentContainer.insertAdjacentHTML("afterbegin",
                            `<div class="comment">
                                <div class="comment-info">
                                    <p class="author">${comment.author}</p>
                                    <p class="time" class="comment-time">${comment.time}</p>
                                </div>
                                <p class="content">${comment.content}</p>
                            </div>`
                        );
                    }
                },
                error: function (req, status, err) {
                    const res = req.responseJSON;

                    if (res && res.message)
                        alert(res.message);

                    return;
                }
            });

            // 수정 버튼
            $("#edit-btn").on("click", function () {
                const cookies = document.cookie.split(';');
                const name = "authorization";

                let token;

                for (let cookie of cookies) {
                    const [key, value] = cookie.trim().split('=');
                    if (key === name) {
                        token = value;
                        break;
                    };
                }

                const decoded = jwt_decode(token);

                if (decoded.userId !== authorId) return;

                window.location.replace(`./post.html?id=${postId}`);
            })

            // 삭제 버튼
            $("#delete-btn").on("click", function () {
                $.ajax({
                    url: root + `/posts/${postId}`,
                    method: 'delete',
                    success: function (data) {
                        if (data && data.message)
                            alert(data.message);

                        window.location.replace('./index.html');
                    },
                    error: function (req, status, err) {
                        const res = req.responseJSON;

                        if (res && res.message)
                            alert(res.message);

                        return;
                    }
                });
            })

        })
    </script>
</head>

<body>
    <header>
        <h1 id="my-title"><a href="./index.html">게시판</a></h1>
        <ul>
            <li><a href="./signup.html">회원가입</a></li>
            <li><a href="./login.html">로그인</a></li>
        </ul>
    </header>
    <div id="post-container">
        <div id="post-header">
            <h1 id="title">글 제목</h1>
            <div id="post-info">
                <p class="time" id="post-time">작성(수정)시간</p>
                <p id="author">작성자</p>
            </div>
            <div id="post-btns">
                <button type="button" id="edit-btn">수정</button>
                <button type="button" id="delete-btn">삭제</button>
            </div>
        </div>
        <div id="post-content">
            <p>
                글 내용
            </p>
        </div>
        <div id="comment-container">
            <div class="comment">
                <div class="comment-info">
                    <p class="author">작성자</p>
                    <p class="time" class="comment-time">작성시간</p>
                </div>
                <p class="content">댓글 내용</p>
            </div>
        </div>
        <div id="input-comment">

        </div>
    </div>
</body>

</html>